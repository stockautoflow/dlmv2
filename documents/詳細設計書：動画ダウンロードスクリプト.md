# **詳細設計書：動画ダウンロードスクリプト**

## **1\. 概要**

本スクリプトは、前フェーズで生成されたurls\_XXX.yamlファイルをインプットとして、ファイル内に記載されたメタデータから**動画ページのURL**を組み立て、yt-dlpを用いて動画をダウンロードする。ダウンロードした動画は、指定された命名規則に基づいてディレクトリ構造とファイル名を生成し、保存することを目的とする。

## **2\. 機能要件**

* **YAMLファイルの読み込み**: コマンドライン引数で指定されたurls\_XXX.yamlファイルを読み込み、解析する。  
* **動画ページURLの生成**: YAML内のidとverタグ、および外部設定ファイル（config.json）のvideo\_url\_baseを基に、ダウンロード対象の動画ページURLを動的に生成する。  
* **ディレクトリパス生成**: YAML内のlesson, versions, song\_numberタグを基に、ルールに従った保存先ディレクトリパスを動的に生成する。  
* **ファイル名生成**: song\_numberとtitleタグを基に、ルールに従ったファイル名を生成する。  
* **ファイル名サニタイズ**: OSのファイル名として使用できない文字（例: ?, :, /など）を自動的に除去する。  
* **動画ダウンロード**: yt-dlpを利用して、動画ページのURLから直接動画をダウンロードし、単一の動画ファイル（.mp4形式）として保存する。  
* **進捗表示**: どのファイルをダウンロード中か、成功したか、失敗したかをコンソールに表示する。  
* **エラーハンドリング**: status: ERRORのエントリや、ダウンロードに失敗した動画をスキップし、処理を継続する。

## **3\. 技術選定**

* **言語**: Python 3  
* **YAML解析**: PyYAMLライブラリ。  
* **動画ダウンロード**: **yt-dlp**  
  * **選定理由**: 認証が不要な場合、yt-dlpは動画ページのURLから直接m3u8プレイリストを自動的に検出し、ダウンロードまでを一貫して行うことができる。これにより、前段のスクリプトでm3u8のURLを事前に抽出する必要がなくなり、処理が簡素化され、ウェブサイトの仕様変更にも強くなる。  
  * **前提条件**: 本スクリプトを実行する環境には、**yt-dlpがインストールされている必要がある。** Pythonから利用するため、yt-dlpライブラリもインストールする。  
* **コマンドライン引数処理**: Python標準ライブラリのargparseを使用する。  
* **ファイルシステム操作**: Python標準ライブラリのosを使用する。

## **4\. 処理フロー**

1. **スクリプト起動**: python download\_videos.py urls\_YYYY-MM-DD-HHMMSS.yaml のように、YAMLファイルを引数としてスクリプトを実行する。  
2. **YAML読み込み**: 指定されたYAMLファイルを読み込み、Pythonのリスト/辞書オブジェクトに変換する。  
3. **メインループ**: YAMLデータの各エントリ（動画IDごとのデータ）に対してループ処理を開始する。  
4. **エントリ解析**:  
   * status: ERRORが含まれるエントリは、ログに記録してスキップする。  
   * versionsキーを持つか、トップレベルにurlキーを持つかを判定する。  
5. **URL・パス・ファイル名生成**:  
   * 各エントリに対して、後述の「5. 命名規則」に基づき、保存先のディレクトリパスとファイル名を生成する。  
   * 同時に、ダウンロード対象の**動画ページのURL**を生成する。  
   * ファイル名から使用不可能な文字を除去する。  
6. **ディレクトリ作成**: os.makedirsを使用し、生成されたディレクトリパスが存在しない場合は再帰的に作成する。  
7. **ダウンロード処理**:  
   * yt-dlpを呼び出すコマンドを生成する (例: yt-dlp \-o "出力ファイルパス.mp4" "動画ページのURL")。  
   * Pythonのsubprocessモジュールまたはyt-dlpライブラリを使い、コマンドを実行する。  
   * yt-dlpの実行結果を監視し、成功または失敗を判定する。  
8. **結果出力**:  
   * ダウンロードの成功、失敗、スキップをコンソールに表示する。  
9. **ループ終了**: 全てのエントリの処理が完了したら、最終的なサマリー（成功/失敗/スキップの件数）を表示してスクリプトを終了する。

## **5\. 命名規則**

### **5.1. ディレクトリ名**

* **ルートディレクトリ**: lessonタグの値（例: SingAlong\!）。  
* **バージョンサブディレクトリ** (versionsタグが存在する場合のみ):  
  * ver: 1 → \_Lyrics  
  * ver: 2 → \_Vocabulary  
  * ver: 3 → \_Karaoke  
  * 結合例: SingAlong\_Lyrics  
* **番号サブディレクトリ**:  
  * song\_numberタグのハイフンより前の数値で決定。  
  * 1-X → 01  
  * 2-X → 02  
  * 3-X → 03  
  * 4-X → 04  
* **最終的なディレクトリパス例**: SingAlong\_Lyrics/01

### **5.2. ファイル名**

* **接頭辞**:  
  * song\_numberタグのハイフンより後の数値を2桁のゼロ埋めで表現。  
  * X-1 → X-01\_  
  * X-2 → X-02\_  
* **本体**: titleタグの値。  
* **サニタイズ**: ファイル名として使用できない文字 \[\\\\/\*?:"\<\>|\] を除去する。  
* **拡張子**: .mp4  
* **最終的なファイル名例**: 1-01\_What's Your Name (Characters).mp4

## **6\. モジュール設計**

* **download\_videos.py**:  
  * メインの実行スクリプト。コマンドライン引数の解析、YAMLの読み込み、メインループの制御を担当する。  
* **path\_formatter.py (新規)**:  
  * YAMLのデータブロックを引数に取り、上記の命名規則に従って、完全な出力ディレクトリパスとサニタイズ済みのファイル名を生成して返す責務を持つ。  
* **downloader.py (新規)**:  
  * **動画ページのURL**と出力先のフルパスを引数に取り、yt-dlpのサブプロセスを実行して動画をダウンロードする責務を持つ。yt-dlpの存在チェックも行う。

## **7\. 実行方法**

\# 依存ライブラリをインストール  
pip install pyyaml yt-dlp

\# スクリプトを実行（YAMLファイルを指定）  
python download\_videos.py urls/urls\_2025-07-17-171046.yaml  
